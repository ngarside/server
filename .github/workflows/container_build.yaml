# This is free and unencumbered software released into the public domain.

name: container_build

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      path:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: {contents: read, packages: write}
    steps:

      - name: Checkout
        uses: actions/checkout@v5

      - name: Install dependencies
        run: pip install uv

      - name: Calculate root path
        run: echo "ROOT=$(echo "${{ inputs.path }}" | cut --delimiter / --fields 1)" >> $GITHUB_ENV

      - name: Generate name
        run: echo "NAME=$(uv run scripts/src/namify.py '${{ inputs.path }}')" >> $GITHUB_ENV

      - name: Generate tag
        run: echo "TAG=$(uv run scripts/src/tagify.py '${{ inputs.path }}')" >> $GITHUB_ENV

      - name: Build container
        run: >
          podman build --file "${{ inputs.path }}" --format docker
          --tag ghcr.io/ngarside/$NAME:$TAG .

      - name: Run tests
        run: uv run pytest -rA $ROOT

      - name: Login to registry
        run: >
          podman login ghcr.io --username ${{ github.actor }}
          --password ${{ secrets.GITHUB_TOKEN }}

      - name: Push container to registry
        run: podman push ghcr.io/ngarside/$NAME:$TAG
