# This is free and unencumbered software released into the public domain.
# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: 3
set: [pipefail]
vars:
  service:
    sh: |
      # If the 'service' variable has been set manually then use it as is.
      if [ -n '{{.service}}' ]; then
        echo '{{.service}}'

      # If we're in a child directory then use the directory's name.
      elif [ "$PWD" = "$(dirname '{{.USER_WORKING_DIR}}')" ]; then
        echo "$(basename '{{.USER_WORKING_DIR}}')"

      # Otherwise default to nothing and let the precondition catch it.
      fi
  image:
    sh: |
      # If the 'image' variable has been set manually then use it as is.
      if [ -n '{{.image}}' ]; then
        echo '{{.image}}'

      # If the 'service' variable has been set manually then default to it.
      elif [ -n '{{.service}}' ]; then
        echo '{{.service}}'

      # If we're in a child directory then use the directory's name.
      elif [ "$PWD" = "$(dirname '{{.USER_WORKING_DIR}}')" ]; then
        echo "$(basename '{{.USER_WORKING_DIR}}')"

      # Otherwise default to nothing and let the precondition catch it.
      fi
tasks:

  auth:
    cmd: |
      case "$(git remote get-url origin)" in
        https://*) protocol=https ;;
        *) protocol=ssh ;;
      esac
      gh auth login \
        --git-protocol $protocol \
        --hostname github.com \
        --scopes delete:packages,read:packages \
        {{.CLI_ARGS}}
    desc: Authenticate with the GitHub CLI
    silent: true

  default:
    cmd: task --list-all
    desc: List all tasks
    silent: true

  build:
    cmd: >-
      podman build
      --format docker
      --file {{.service}}/src/{{.image}}.dockerfile
      --tag ghcr.io/ngarside/{{.service}}-{{.image}}
      $PWD
    desc: Build the container for the given service
    preconditions:
      - sh: test -n '{{.service}}' || test -n '{{.image}}'
        msg: task build service=<service> [image=<image>]
    silent: true

  clear:
    cmds:
      - podman kill --all
      - podman image rm --all --force
    desc: Kill all running containers and delete all local images
    silent: true

  install:
    cmds:
      - pip install uv
      - uv pip install --requirements pyproject.toml
    desc: Install development dependencies
    silent: true

  pull:
    cmd: |
      versions=$(gh api users/ngarside/packages/container/{{.service}}-{{.image}}/versions)
      tag=$(echo "$versions" | jq --raw-output '
        sort_by(.created_at)
        | [.[].metadata.container.tags[]]
        | map(select(test("^[\\d\\.]+$")))
        | last
      ')
      image="ghcr.io/ngarside/{{.service}}-{{.image}}:$tag"
      podman pull "$image"
      podman tag "$image" "ghcr.io/ngarside/{{.service}}-{{.image}}:latest"
      podman image rm "$image"
    desc: Pull the latest container image for the given service
    preconditions:
      - sh: test -n '{{.service}}' || test -n '{{.image}}'
        msg: task build service=<service> [image=<image>]
    silent: true

  purge:
    cmd: |
      export GITHUB_TOKEN=$(gh auth token)
      python3 scripts/src/purge.py
    desc: Delete all unused container images from the GitHub registry
    silent: true

  rebuild:
    cmd: >-
      podman build
      --format docker
      --file {{.service}}/src/{{.image}}.dockerfile
      --no-cache
      --tag ghcr.io/ngarside/{{.service}}-{{.image}}
      $PWD
    desc: Build the container for the given service (without cache)
    preconditions:
      - sh: test -n '{{.service}}' || test -n '{{.image}}'
        msg: task build service=<service> [image=<image>]
    silent: true

  run:
    cmd: >-
      podman run
      --interactive --publish-all --rm --tty
      --volume /etc/pki/ca-trust/extracted/pem:/etc/pki/ca-trust/extracted/pem:ro
      ghcr.io/ngarside/{{.service}}-{{.image}}
      {{.CLI_ARGS}}
    desc: Run the container for the given service
    preconditions:
      - sh: test -n '{{.service}}' || test -n '{{.image}}'
        msg: task build service=<service> [image=<image>] [-- args]
    silent: true

  test:
    cmd: uv run --locked pytest -rA {{.service}}/test/{{.image}}.py
    desc: Run tests for the given service
    preconditions:
      - sh: test -n '{{.service}}' || test -n '{{.image}}'
        msg: task build service=<service> [image=<image>]
    silent: true
