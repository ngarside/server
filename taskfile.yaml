# This is free and unencumbered software released into the public domain.
# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: 3
set: [pipefail]
vars:
  image:
  dockerfile:
    sh: echo "$(python scripts/src/specifier_to_dockerfile.py {{.image}})" 2> /dev/null
  imagename:
    sh: echo "$(python scripts/src/specifier_to_imagename.py {{.image}})" 2> /dev/null
  testfile:
    sh: echo "$(python scripts/src/specifier_to_testfile.py {{.image}})" 2> /dev/null
tasks:

  auth:
    cmd: |
      case "$(git remote get-url origin)" in
        https://*) protocol=https ;;
        *) protocol=ssh ;;
      esac
      gh auth login \
        --git-protocol $protocol \
        --hostname github.com \
        --scopes delete:packages,read:packages \
        {{.CLI_ARGS}}
    desc: Authenticate with the GitHub CLI
    silent: true

  default:
    cmd: task --list-all
    desc: List all tasks
    silent: true

  build:
    cmd: podman build --format docker --file {{.dockerfile}} --tag {{.imagename}} $PWD
    desc: Build the container for the given image
    preconditions:
      - sh: test -n '{{.image}}'
        msg: task build image=<image>
    silent: true

  clear:
    cmds:
      - podman kill --all
      - podman image rm --all --force
    desc: Kill all running containers and delete all local images
    silent: true

  install:
    cmds:
      - pip install uv
      - uv pip install --requirements pyproject.toml
    desc: Install development dependencies
    silent: true

  pull:
    cmd: podman pull {{.imagename}}
    desc: Pull the latest container image for the given service
    preconditions:
      - sh: test -n '{{.image}}'
        msg: task pull image=<image>
    silent: true

  purge:
    cmd: |
      export GITHUB_TOKEN=$(gh auth token)
      python3 scripts/src/purge.py
    desc: Delete all unused container images from the GitHub registry
    silent: true

  rebuild:
    cmd: podman build --format docker --file {{.dockerfile}} --no-cache --tag {{.imagename}} $PWD
    desc: Build the container for the given image (without cache)
    preconditions:
      - sh: test -n '{{.image}}'
        msg: task rebuild image=<image>
    silent: true

  run:
    cmd: >-
      podman run
      --interactive --publish-all --rm --tty
      --volume /etc/pki/ca-trust/extracted/pem:/etc/pki/ca-trust/extracted/pem:ro
      {{.imagename}} {{.CLI_ARGS}}
    desc: Run the container for the given image
    preconditions:
      - sh: test -n '{{.image}}'
        msg: task run image=<image> [-- args]
    silent: true

  test:
    cmd: uv run --locked pytest -rA {{.testfile}}
    desc: Run tests for the given image
    preconditions:
      - sh: test -n '{{.image}}'
        msg: task test image=<image>
    silent: true
