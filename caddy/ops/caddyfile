# This is free and unencumbered software released into the public domain.

(common) {
	header {
		Content-Security-Policy: default-src 'self'; frame-ancestors 'self'; form-action 'self'; upgrade-insecure-requests
		Cross-Origin-Opener-Policy: same-origin
		Cross-Origin-Resource-Policy: same-origin
		X-Content-Type-Options: nosniff
		X-Frame-Options SAMEORIGIN
	}
	request_body {
		max_size 100mb
	}
	tls {
		dns cloudflare {file./run/secrets/cloudflare_api_token}
		resolvers 1.1.1.1
	}
}

(authentik_forward_auth) {
	reverse_proxy /outpost.goauthentik.io/* 10.8.0.3
	forward_auth 10.8.0.3 {
		uri /outpost.goauthentik.io/auth/caddy
		copy_headers {
			X-Authentik-Email
			X-Authentik-Entitlements
			X-Authentik-Groups
			X-Authentik-Jwt
			X-Authentik-Meta-App
			X-Authentik-Meta-Jwks
			X-Authentik-Meta-Outpost
			X-Authentik-Meta-Provider
			X-Authentik-Meta-Version
			X-Authentik-Name
			X-Authentik-Uid
			X-Authentik-Username
		}
	}
}

* {
	import common

	@root host {file./run/secrets/machine_domain_root}
	handle @root {
		reverse_proxy 10.8.0.3
	}

	@adguardhome host adguardhome.{file./run/secrets/machine_domain_root}
	handle @adguardhome {
		route {
			import authentik_forward_auth
			reverse_proxy 10.2.0.2
		}
	}

	@chartdb host chartdb.{file./run/secrets/machine_domain_root}
	handle @chartdb {
		route {
			import authentik_forward_auth
			reverse_proxy 10.16.0.2
		}
	}

	@excalidraw host excalidraw.{file./run/secrets/machine_domain_root}
	handle @excalidraw {
		route {
			import authentik_forward_auth
			reverse_proxy 10.18.0.2
		}
	}

	@fossflow host fossflow.{file./run/secrets/machine_domain_root}
	handle @fossflow {
		route {
			import authentik_forward_auth
			reverse_proxy 10.1.0.2
		}
	}

	@gitea host gitea.{file./run/secrets/machine_domain_root}
	handle @gitea {
		reverse_proxy 10.14.0.2
	}

	@jellyfin host jellyfin.{file./run/secrets/machine_domain_root}
	handle @jellyfin {
		reverse_proxy 10.11.0.2:8096
	}

	@memos host memos.{file./run/secrets/machine_domain_root}
	handle @memos {
		reverse_proxy 10.6.0.2
	}

	@opencloud host opencloud.{file./run/secrets/machine_domain_root}
	handle @opencloud {
		reverse_proxy 10.17.0.2
	}

	@outline host outline.{file./run/secrets/machine_domain_root}
	handle @outline {
		reverse_proxy 10.10.0.2
	}

	@penpot host penpot.{file./run/secrets/machine_domain_root}
	handle @penpot {
		reverse_proxy 10.3.0.9:8080
	}

	@vaultwarden host vaultwarden.{file./run/secrets/machine_domain_root}
	handle @vaultwarden {
		reverse_proxy 10.12.0.2
	}

	@whoami host whoami.{file./run/secrets/machine_domain_root}
	handle @whoami {
		route {
			import authentik_forward_auth
			reverse_proxy 10.20.0.2
		}
	}

	@youtrack host youtrack.{file./run/secrets/machine_domain_root}
	handle @youtrack {
		reverse_proxy 10.9.0.2:8080
	}
}
