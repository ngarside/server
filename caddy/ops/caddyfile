# This is free and unencumbered software released into the public domain.

(common) {
	header {
		Content-Security-Policy: default-src 'self'; frame-ancestors 'self'; form-action 'self'; upgrade-insecure-requests
		Cross-Origin-Opener-Policy: same-origin
		Cross-Origin-Resource-Policy: same-origin
		X-Content-Type-Options: nosniff
		X-Frame-Options SAMEORIGIN
	}
	request_body {
		max_size 100mb
	}
	tls {
		dns cloudflare {file./run/secrets/cloudflare_api_token}
		resolvers 1.1.1.1
	}
}

*.{file./run/secrets/machine_domain_root} {
	import common
}

{file./run/secrets/machine_domain_root} {
	import common
	reverse_proxy 10.8.0.3:9000
}

adguardhome.{file./run/secrets/machine_domain_root} {
	route {
		reverse_proxy /outpost.goauthentik.io/* 10.8.0.3:9000
		forward_auth 10.8.0.3:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers {
				X-Authentik-Email
				X-Authentik-Entitlements
				X-Authentik-Groups
				X-Authentik-Jwt
				X-Authentik-Meta-App
				X-Authentik-Meta-Jwks
				X-Authentik-Meta-Outpost
				X-Authentik-Meta-Provider
				X-Authentik-Meta-Version
				X-Authentik-Name
				X-Authentik-Uid
				X-Authentik-Username
			}
		}
		reverse_proxy 10.2.0.2
	}
}

chartdb.{file./run/secrets/machine_domain_root} {
	route {
		reverse_proxy /outpost.goauthentik.io/* 10.8.0.3:9000
		forward_auth 10.8.0.3:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers {
				X-Authentik-Email
				X-Authentik-Entitlements
				X-Authentik-Groups
				X-Authentik-Jwt
				X-Authentik-Meta-App
				X-Authentik-Meta-Jwks
				X-Authentik-Meta-Outpost
				X-Authentik-Meta-Provider
				X-Authentik-Meta-Version
				X-Authentik-Name
				X-Authentik-Uid
				X-Authentik-Username
			}
		}
		reverse_proxy 10.16.0.2
	}
}

excalidraw.{file./run/secrets/machine_domain_root} {
	route {
		reverse_proxy /outpost.goauthentik.io/* 10.8.0.3:9000
		forward_auth 10.8.0.3:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers {
				X-Authentik-Email
				X-Authentik-Entitlements
				X-Authentik-Groups
				X-Authentik-Jwt
				X-Authentik-Meta-App
				X-Authentik-Meta-Jwks
				X-Authentik-Meta-Outpost
				X-Authentik-Meta-Provider
				X-Authentik-Meta-Version
				X-Authentik-Name
				X-Authentik-Uid
				X-Authentik-Username
			}
		}
		reverse_proxy 10.18.0.2
	}
}

fossflow.{file./run/secrets/machine_domain_root} {
	route {
		reverse_proxy /outpost.goauthentik.io/* 10.8.0.3:9000
		forward_auth 10.8.0.3:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers {
				X-Authentik-Email
				X-Authentik-Entitlements
				X-Authentik-Groups
				X-Authentik-Jwt
				X-Authentik-Meta-App
				X-Authentik-Meta-Jwks
				X-Authentik-Meta-Outpost
				X-Authentik-Meta-Provider
				X-Authentik-Meta-Version
				X-Authentik-Name
				X-Authentik-Uid
				X-Authentik-Username
			}
		}
		reverse_proxy 10.1.0.2
	}
}

gitea.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.14.0.2
}

jellyfin.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.11.0.2:8096
}

memos.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.6.0.2
}

opencloud.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.17.0.2:9200
}

outline.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.10.0.2:8080
}

penpot.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.3.0.9:8080
}

vaultwarden.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.12.0.2
}

youtrack.{file./run/secrets/machine_domain_root} {
	reverse_proxy 10.9.0.2:8080
}
